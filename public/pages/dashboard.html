<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "custom-blue": "#3b82f6",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 md:px-8 py-10 max-w-5xl">
      <div class="mb-8">
        <h1
          class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight"
          id="headerGreeting"
        >
          Halo, User!
        </h1>
        <p class="text-gray-600 mt-2 text-lg">
          Selamat datang kembali di panel profil Anda.
        </p>
      </div>

      <div
        class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8 transition hover:shadow-md"
      >
        <div
          class="flex flex-col md:flex-row items-center md:items-start gap-6"
        >
          <div class="flex-shrink-0">
            <div
              class="w-24 h-24 bg-gradient-to-br from-custom-blue to-blue-600 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg ring-4 ring-blue-50"
            >
              <span id="userInitials">U</span>
            </div>
          </div>

          <div class="flex-1 text-center md:text-left w-full">
            <div
              class="flex flex-col md:flex-row md:justify-between md:items-center mb-2"
            >
              <h2 class="text-2xl font-bold text-gray-900" id="userName">
                Memuat...
              </h2>

              <span
                id="statusBadge"
                class="mt-2 md:mt-0 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
              >
                Checking...
              </span>
            </div>

            <div
              class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 bg-gray-50 p-4 rounded-xl border border-gray-100"
            >
              <div class="flex items-center justify-center md:justify-start">
                <div
                  class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-custom-blue mr-3 shadow-sm border border-gray-100"
                >
                  <i class="fas fa-phone-alt text-sm"></i>
                </div>
                <div>
                  <p
                    class="text-xs text-gray-500 uppercase tracking-wider font-bold"
                  >
                    Nomor Telepon
                  </p>
                  <p class="font-semibold text-gray-800" id="userPhone">-</p>
                </div>
              </div>

              <div class="flex items-center justify-center md:justify-start">
                <div
                  class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-600 mr-3 shadow-sm border border-gray-100"
                >
                  <i class="fas fa-calendar-check text-sm"></i>
                </div>
                <div>
                  <p
                    class="text-xs text-gray-500 uppercase tracking-wider font-bold"
                  >
                    Member Since
                  </p>
                  <p class="font-semibold text-gray-800" id="memberSince">-</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div
          class="flex items-center justify-between mb-6 border-b border-gray-200 pb-4"
        >
          <h3 class="text-xl font-bold text-gray-800">Data Preferensi</h3>
          <a
            href="/questionnaire.html"
            class="text-sm font-semibold text-custom-blue hover:text-blue-700 flex items-center transition group"
          >
            <span class="group-hover:underline">Edit Data</span>
            <i class="fas fa-chevron-right ml-2 text-xs"></i>
          </a>
        </div>

        <div id="loadingState" class="text-center py-12">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-custom-blue mx-auto"
          ></div>
          <p class="text-gray-400 mt-4 text-sm">Mengambil data...</p>
        </div>

        <div
          id="emptyState"
          class="hidden bg-white rounded-xl shadow-sm border border-dashed border-gray-300 p-10 text-center"
        >
          <div
            class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400"
          >
            <i class="fas fa-clipboard-list text-2xl"></i>
          </div>
          <h3 class="text-lg font-bold text-gray-900">Data Belum Tersedia</h3>
          <p class="text-gray-500 mb-6">
            Lengkapi profil penggunaan Anda untuk hasil rekomendasi yang akurat.
          </p>
          <a
            href="/questionnaire.html"
            class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-custom-blue hover:bg-blue-700 transition shadow-sm"
          >
            Isi Kuesioner
          </a>
        </div>

        <div
          id="dataGrid"
          class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"
        >
          <div
            class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-blue-400 transition group relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"
            ></div>
            <div class="flex items-center justify-between mb-3 relative z-10">
              <span class="text-xs font-bold text-gray-400 uppercase"
                >Internet</span
              >
              <i class="fas fa-wifi text-blue-500"></i>
            </div>
            <p
              class="text-xl font-bold text-gray-800 group-hover:text-custom-blue transition relative z-10"
              id="valInternet"
            >
              -
            </p>
            <p class="text-xs text-gray-500 mt-1 relative z-10">
              Penggunaan Harian
            </p>
          </div>

          <div
            class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-green-400 transition group relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-16 h-16 bg-green-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"
            ></div>
            <div class="flex items-center justify-between mb-3 relative z-10">
              <span class="text-xs font-bold text-gray-400 uppercase"
                >Budget</span
              >
              <i class="fas fa-wallet text-green-500"></i>
            </div>
            <p
              class="text-xl font-bold text-gray-800 group-hover:text-green-600 transition relative z-10"
              id="valBudget"
            >
              -
            </p>
            <p class="text-xs text-gray-500 mt-1 relative z-10">
              Estimasi Bulanan
            </p>
          </div>

          <div
            class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-red-400 transition group relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"
            ></div>
            <div class="flex items-center justify-between mb-3 relative z-10">
              <span class="text-xs font-bold text-gray-400 uppercase"
                >Streaming</span
              >
              <i class="fas fa-play-circle text-red-500"></i>
            </div>
            <p
              class="text-xl font-bold text-gray-800 group-hover:text-red-600 transition relative z-10"
              id="valStream"
            >
              -
            </p>
            <p class="text-xs text-gray-500 mt-1 relative z-10">
              Kebiasaan Nonton
            </p>
          </div>

          <div
            class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-yellow-400 transition group relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-16 h-16 bg-yellow-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"
            ></div>
            <div class="flex items-center justify-between mb-3 relative z-10">
              <span class="text-xs font-bold text-gray-400 uppercase"
                >Telepon</span
              >
              <i class="fas fa-phone text-yellow-500"></i>
            </div>
            <p
              class="text-xl font-bold text-gray-800 group-hover:text-yellow-600 transition relative z-10"
              id="valVoice"
            >
              -
            </p>
            <p class="text-xs text-gray-500 mt-1 relative z-10">
              Intensitas Panggilan
            </p>
          </div>

          <div
            class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-purple-400 transition group relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-16 h-16 bg-purple-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"
            ></div>
            <div class="flex items-center justify-between mb-3 relative z-10">
              <span class="text-xs font-bold text-gray-400 uppercase">SMS</span>
              <i class="fas fa-comment-alt text-purple-500"></i>
            </div>
            <p
              class="text-xl font-bold text-gray-800 group-hover:text-purple-600 transition relative z-10"
              id="valSMS"
            >
              -
            </p>
            <p class="text-xs text-gray-500 mt-1 relative z-10">
              Penggunaan Pesan
            </p>
          </div>

          <div
            class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-indigo-400 transition group relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"
            ></div>
            <div class="flex items-center justify-between mb-3 relative z-10">
              <span class="text-xs font-bold text-gray-400 uppercase"
                >VOD Service</span
              >
              <i class="fas fa-film text-indigo-500"></i>
            </div>
            <p
              class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition relative z-10"
              id="valVOD"
            >
              -
            </p>
            <p class="text-xs text-gray-500 mt-1 relative z-10">
              Minat Layanan
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5000/api";

      document.addEventListener("DOMContentLoaded", () => {
        loadProfileData();
      });

      async function loadProfileData() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        const loadingEl = document.getElementById("loadingState");
        const dataGridEl = document.getElementById("dataGrid");
        const emptyStateEl = document.getElementById("emptyState");

        // Reset UI
        loadingEl.classList.remove("hidden");
        dataGridEl.classList.add("hidden");
        emptyStateEl.classList.add("hidden");

        try {
          // 1. Fetch Data
          const response = await fetch(`${API_BASE_URL}/questionnaire/data`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 401) {
            localStorage.removeItem("token");
            window.location.href = "/login.html";
            return;
          }

          const result = await response.json();
          const userData = result.user || {};

          // ---------------------------------------------------------
          // UPDATE HEADER & PROFILE CARD
          // ---------------------------------------------------------

          // 1. Nama User
          const name = userData.fullName || "Pengguna";

          // Update Sapaan di Header (Halo, [Nama]!)
          document.getElementById(
            "headerGreeting"
          ).textContent = `Halo, ${name}!`;

          // Update Nama di Card
          document.getElementById("userName").textContent = name;

          // Update Initials Avatar
          document.getElementById("userInitials").textContent = name
            .charAt(0)
            .toUpperCase();

          // 2. Phone Number
          document.getElementById("userPhone").textContent =
            userData.phoneNumber || "-";

          // 3. Member Since
          if (userData.createdAt) {
            const dateObj = new Date(userData.createdAt);
            const options = { year: "numeric", month: "long", day: "numeric" };
            document.getElementById("memberSince").textContent =
              dateObj.toLocaleDateString("id-ID", options);
          } else {
            document.getElementById("memberSince").textContent = "-";
          }

          // ---------------------------------------------------------
          // UPDATE PREFERENCE DATA
          // ---------------------------------------------------------
          const qData = result.questionnaireData || {};

          if (qData && Object.keys(qData).length > 0) {
            // Update Badge Status
            const badge = document.getElementById("statusBadge");
            badge.className =
              "mt-2 md:mt-0 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800";
            badge.innerHTML =
              '<i class="fas fa-check-circle mr-1"></i> Profil Lengkap';

            // Mapping Data
            document.getElementById("valInternet").textContent = mapValue(
              qData.internetUsage,
              "usage"
            );
            document.getElementById("valBudget").textContent = mapValue(
              qData.budget,
              "budget"
            );
            document.getElementById("valStream").textContent = mapValue(
              qData.streamingHabits,
              "freq"
            );
            document.getElementById("valVoice").textContent = mapValue(
              qData.voiceUsage,
              "usage"
            );
            document.getElementById("valSMS").textContent = mapValue(
              qData.smsUsage,
              "usage"
            );

            const vodText =
              qData.vodInterest === true || qData.vodInterest === "true"
                ? "Berminat"
                : "Tidak";
            document.getElementById("valVOD").textContent = vodText;

            loadingEl.classList.add("hidden");
            dataGridEl.classList.remove("hidden");
          } else {
            // Data Kosong
            const badge = document.getElementById("statusBadge");
            badge.className =
              "mt-2 md:mt-0 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800";
            badge.innerHTML =
              '<i class="fas fa-exclamation-circle mr-1"></i> Belum Lengkap';

            loadingEl.classList.add("hidden");
            emptyStateEl.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
          loadingEl.innerHTML =
            '<p class="text-red-500">Gagal memuat data.</p>';
        }
      }

      function mapValue(val, type) {
        if (!val) return "-";
        const v = val.toString().toLowerCase();
        const maps = {
          usage: {
            low: "Rendah",
            medium: "Sedang",
            high: "Tinggi",
            "very-high": "Sangat Tinggi",
            moderate: "Moderat",
          },
          budget: {
            economy: "Ekonomis",
            standard: "Standar",
            premium: "Premium",
            "mid-range": "Menengah",
            vip: "Sultan",
          },
          freq: {
            none: "Tidak Pernah",
            occasional: "Kadang",
            frequent: "Sering",
            daily: "Setiap Hari",
            rarely: "Jarang",
            sometimes: "Kadang",
            often: "Sering",
          },
        };
        return maps[type] && maps[type][v]
          ? maps[type][v]
          : v.charAt(0).toUpperCase() + v.slice(1);
      }
    </script>
  </body>
</html>
